<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recortar Imagen a Círculo 1200x1200</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        .container {
            margin: 20px 0;
        }
        #imagePreview {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px dashed #ccc;
            margin: 20px auto;
            display: none;
        }
        #canvasOutput {
            display: none;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        input[type="file"] {
            display: none;
        }
        .custom-file-upload {
            border: 1px solid #ccc;
            display: inline-block;
            padding: 10px 15px;
            cursor: pointer;
            background-color: #f8f8f8;
            border-radius: 4px;
        }
        .custom-file-upload:hover {
            background-color: #e8e8e8;
        }
        .instructions {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: left;
        }
    </style>
</head>
<body>
    <h1>Recortar Imagen a Círculo 1200x1200</h1>
    
    <div class="instructions">
        <h3>Instrucciones:</h3>
        <ol>
            <li>Selecciona una imagen haciendo clic en "Elegir Imagen"</li>
            <li>La imagen se mostrará con un recorte circular previo</li>
            <li>Puedes arrastrar la imagen para ajustar el recorte</li>
            <li>Haz clic en "Descargar Imagen" para guardar el resultado como PNG (1200x1200)</li>
        </ol>
    </div>
    
    <div class="container">
        <label for="imageUpload" class="custom-file-upload">
            Elegir Imagen
        </label>
        <input type="file" id="imageUpload" accept="image/*">
        
        <div class="controls">
            <button id="downloadBtn" disabled>Descargar Imagen</button>
        </div>
    </div>
    
    <div>
        <img id="imagePreview" alt="Vista previa">
    </div>
    
    <canvas id="canvasOutput" width="1200" height="1200"></canvas>
    
    <script>
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const downloadBtn = document.getElementById('downloadBtn');
        const canvasOutput = document.getElementById('canvasOutput');
        const ctx = canvasOutput.getContext('2d');
        
        let currentImage = null;
        let isDragging = false;
        let startX, startY;
        let offsetX = 0, offsetY = 0;
        let scale = 1;
        
        imageUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        currentImage = img;
                        resetImagePosition();
                        updatePreview();
                        downloadBtn.disabled = false;
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
        
        imagePreview.addEventListener('mousedown', function(e) {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
        });
        
        window.addEventListener('mousemove', function(e) {
            if (isDragging && currentImage) {
                offsetX += e.clientX - startX;
                offsetY += e.clientY - startY;
                startX = e.clientX;
                startY = e.clientY;
                updatePreview();
            }
        });
        
        window.addEventListener('mouseup', function() {
            isDragging = false;
        });
        
        imagePreview.addEventListener('wheel', function(e) {
            e.preventDefault();
            if (currentImage) {
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                scale = Math.max(0.1, Math.min(scale + delta, 3));
                updatePreview();
            }
        }, { passive: false });
        
        function resetImagePosition() {
            offsetX = 0;
            offsetY = 0;
            scale = 1;
        }
        
        function updatePreview() {
            if (!currentImage) return;
            
            // Actualizar vista previa pequeña
            const previewSize = 300;
            const previewCtx = document.createElement('canvas').getContext('2d');
            previewCtx.canvas.width = previewSize;
            previewCtx.canvas.height = previewSize;
            
            // Crear máscara circular
            previewCtx.beginPath();
            previewCtx.arc(previewSize/2, previewSize/2, previewSize/2, 0, Math.PI*2);
            previewCtx.closePath();
            previewCtx.clip();
            
            // Calcular dimensiones para mantener relación de aspecto
            const imgRatio = currentImage.width / currentImage.height;
            let drawWidth, drawHeight;
            
            if (imgRatio > 1) {
                drawHeight = previewSize;
                drawWidth = drawHeight * imgRatio;
            } else {
                drawWidth = previewSize;
                drawHeight = drawWidth / imgRatio;
            }
            
            // Aplicar escala y desplazamiento
            drawWidth *= scale;
            drawHeight *= scale;
            
            const x = (previewSize - drawWidth) / 2 + offsetX * (scale / 2);
            const y = (previewSize - drawHeight) / 2 + offsetY * (scale / 2);
            
            previewCtx.drawImage(currentImage, x, y, drawWidth, drawHeight);
            
            imagePreview.src = previewCtx.canvas.toDataURL();
            imagePreview.style.display = 'block';
        }
        
        downloadBtn.addEventListener('click', function() {
            if (!currentImage) return;
            
            // Limpiar canvas
            ctx.clearRect(0, 0, 1200, 1200);
            
            // Crear máscara circular
            ctx.beginPath();
            ctx.arc(600, 600, 600, 0, Math.PI*2);
            ctx.closePath();
            ctx.clip();
            
            // Calcular dimensiones para mantener relación de aspecto
            const imgRatio = currentImage.width / currentImage.height;
            let drawWidth, drawHeight;
            
            if (imgRatio > 1) {
                drawHeight = 1200;
                drawWidth = drawHeight * imgRatio;
            } else {
                drawWidth = 1200;
                drawHeight = drawWidth / imgRatio;
            }
            
            // Aplicar escala y desplazamiento (ajustados para el tamaño final)
            const finalScale = scale * (300 / 1200); // Ajustar escala de vista previa a tamaño final
            drawWidth *= finalScale;
            drawHeight *= finalScale;
            
            const x = (1200 - drawWidth) / 2 + offsetX * (finalScale * 4);
            const y = (1200 - drawHeight) / 2 + offsetY * (finalScale * 4);
            
            // Dibujar imagen en canvas de 1200x1200
            ctx.drawImage(currentImage, x, y, drawWidth, drawHeight);
            
            // Crear enlace de descarga
            const link = document.createElement('a');
            link.download = 'imagen-recortada.png';
            link.href = canvasOutput.toDataURL('image/png');
            link.click();
        });
    </script>
</body>
</html>